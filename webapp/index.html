<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LiveKit Transcription Test</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.15.9/dist/livekit-client.umd.min.js"></script>
    <script type="module">
      import { AccessToken } from "https://cdn.jsdelivr.net/npm/livekit-server-sdk@2.14.0/+esm";
      window.LivekitServerSdk = { AccessToken };
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1100px;
        margin: 50px auto;
        padding: 20px;
      }
      input,
      button,
      textarea {
        margin: 10px 0;
        padding: 10px;
        font-size: 14px;
      }
      input {
        width: 300px;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px 20px;
        margin-right: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #endBtn {
        background-color: #f44336;
      }
      #endBtn:hover {
        background-color: #da190b;
      }
      .participant-container {
        margin: 20px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        background-color: #f9f9f9;
      }
      .participant-header {
        font-weight: bold;
        margin-bottom: 10px;
        padding: 5px;
        background-color: #e0e0e0;
        border-radius: 3px;
      }
      .participant-name {
        color: #2196f3;
      }
      .room-name {
        color: #4caf50;
      }
      textarea {
        width: 100%;
        height: 200px;
        font-family: monospace;
        resize: vertical;
      }
    </style>
  </head>
  <body>
    <h1>LiveKit Transcription Test</h1>

    <div>
      <label for="roomName">Room Name:</label><br />
      <input
        type="text"
        id="roomName"
        value="test-room"
        placeholder="Enter room name"
      />
    </div>

    <button id="connectBtn">Connect New Participant</button>
    <button id="endBtn">End Test</button>

    <div id="participantsContainer"></div>

    <script>
      const LIVEKIT_URL = "wss://your-livekit-url";
      const LIVEKIT_API_KEY = "your-livekit-api-key";
      const LIVEKIT_API_SECRET = "your-livekit-api-secret";

      let rooms = [];

      const connectBtn = document.getElementById("connectBtn");
      const endBtn = document.getElementById("endBtn");
      const roomNameInput = document.getElementById("roomName");
      const participantsContainer = document.getElementById(
        "participantsContainer"
      );

      function createParticipantTextArea(participantName, roomName) {
        // Create container for this participant
        const container = document.createElement("div");
        container.className = "participant-container";
        container.id = `participant-${participantName}`;

        // Create header with participant and room info
        const header = document.createElement("div");
        header.className = "participant-header";
        header.innerHTML = `<span class="participant-name">${participantName}</span> @ <span class="room-name">${roomName}</span>`;

        // Create textarea for transcriptions
        const textarea = document.createElement("textarea");
        textarea.id = `transcript-${participantName}`;
        textarea.readOnly = true;

        // Append elements
        container.appendChild(header);
        container.appendChild(textarea);
        participantsContainer.appendChild(container);

        return textarea;
      }

      function log(participantName, message) {
        const timestamp = new Date().toLocaleTimeString();
        const textarea = document.getElementById(
          `transcript-${participantName}`
        );
        if (textarea) {
          textarea.value += `[${timestamp}] ${message}\n`;
          textarea.scrollTop = textarea.scrollHeight;
        }
      }

      function removeParticipantTextArea(participantName) {
        const container = document.getElementById(
          `participant-${participantName}`
        );
        if (container) {
          container.remove();
        }
      }

      async function generateToken(roomName, participantName) {
        // Wait for the module script to load
        while (!window.LivekitServerSdk) {
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        const token = new window.LivekitServerSdk.AccessToken(
          LIVEKIT_API_KEY,
          LIVEKIT_API_SECRET,
          { identity: participantName }
        );
        token.addGrant({
          roomJoin: true,
          room: roomName,
          canPublish: true,
          canSubscribe: false,
        });
        return await token.toJwt();
      }

      async function connectParticipant() {
        const roomName = roomNameInput.value.trim();
        if (!roomName) {
          alert("Please enter a room name");
          return;
        }

        const participantName = `participant-${Math.floor(
          Math.random() * 10000000
        )}`;

        try {
          connectBtn.disabled = true;

          const token = await generateToken(roomName, participantName);

          const room = new LivekitClient.Room();
          rooms.push({ room, participantName, roomName });

          // Create text area for this participant
          createParticipantTextArea(participantName, roomName);
          log(participantName, `Connecting to room: ${roomName}`);

          // Handle transcription
          room.registerTextStreamHandler(
            "lk.transcription",
            async (reader, participantInfo) => {
              const message = await reader.readAll();
              const isFinal =
                reader.info.attributes["lk.transcription_final"] === "true";
              const trackId = reader.info.attributes["lk.transcribed_track_id"];
              const segmentId = reader.info.attributes["lk.segment_id"];
              if (isFinal) {
                log(
                  participantName,
                  `Final transcription from ${participantInfo.identity} [track ${trackId} | segment ${segmentId}]: ${message}`
                );
              } else {
                log(
                  participantName,
                  `Interim transcription from ${participantInfo.identity} [track ${trackId} | segment ${segmentId}]: ${message}`
                );
              }
            }
          );

          // Handle room events
          room.on(LivekitClient.RoomEvent.Connected, () => {
            log(participantName, "Connected to room");
          });

          room.on(LivekitClient.RoomEvent.Disconnected, () => {
            log(participantName, "Disconnected from room");
            connectBtn.disabled = false;
          });

          room.on(
            LivekitClient.RoomEvent.ParticipantConnected,
            (participant) => {
              log(
                participantName,
                `Participant joined: ${participant.identity}`
              );
            }
          );

          // Handle speaking state changes for local participant
          room.localParticipant.on(
            LivekitClient.ParticipantEvent.IsSpeakingChanged,
            (speaking) => {
              if (speaking) {
                log(participantName, "Local participant started speaking");
              } else {
                log(participantName, "Local participant stopped speaking");
              }
            }
          );

          // Connect to room
          await room.connect(LIVEKIT_URL, token, {
            autoSubscribe: false,
          });

          // Publish audio track
          await room.localParticipant.setMicrophoneEnabled(true);

          log(participantName, "Published audio track");
          connectBtn.disabled = false;
        } catch (error) {
          log(participantName, `Error: ${error.message}`);
          connectBtn.disabled = false;
        }
      }

      async function endTest() {
        for (const { room, participantName } of rooms) {
          if (room && room.state === LivekitClient.ConnectionState.Connected) {
            await room.disconnect();
          }
          removeParticipantTextArea(participantName);
        }

        rooms = [];
      }

      connectBtn.addEventListener("click", connectParticipant);
      endBtn.addEventListener("click", endTest);
    </script>
  </body>
</html>
