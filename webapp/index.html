<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LiveKit Transcription Test</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.15.9/dist/livekit-client.umd.min.js"></script>
    <script type="module">
      import { AccessToken } from "https://cdn.jsdelivr.net/npm/livekit-server-sdk@2.14.0/+esm";
      window.LivekitServerSdk = { AccessToken };
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      input,
      button,
      textarea {
        margin: 10px 0;
        padding: 10px;
        font-size: 14px;
      }
      input {
        width: 300px;
      }
      button {
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px 20px;
        margin-right: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #endBtn {
        background-color: #f44336;
      }
      #endBtn:hover {
        background-color: #da190b;
      }
      textarea {
        width: 100%;
        height: 300px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>LiveKit Transcription Test</h1>

    <div>
      <label for="roomName">Room Name:</label><br />
      <input
        type="text"
        id="roomName"
        value="test-room"
        placeholder="Enter room name"
      />
    </div>

    <button id="connectBtn">Connect New Participant</button>
    <button id="endBtn">End Test</button>

    <div>
      <textarea id="transcription" readonly></textarea>
    </div>

    <script>
      const LIVEKIT_URL = "ws://localhost:7880";
      const LIVEKIT_API_KEY = "devkey";
      const LIVEKIT_API_SECRET = "secret";

      let rooms = [];
      let participantCount = 0;

      const connectBtn = document.getElementById("connectBtn");
      const endBtn = document.getElementById("endBtn");
      const roomNameInput = document.getElementById("roomName");
      const transcriptionArea = document.getElementById("transcription");

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        transcriptionArea.value += `[${timestamp}] ${message}\n`;
        transcriptionArea.scrollTop = transcriptionArea.scrollHeight;
      }

      async function generateToken(roomName, participantName) {
        // Wait for the module script to load
        while (!window.LivekitServerSdk) {
          await new Promise((resolve) => setTimeout(resolve, 100));
        }

        const token = new window.LivekitServerSdk.AccessToken(
          LIVEKIT_API_KEY,
          LIVEKIT_API_SECRET,
          { identity: participantName }
        );
        token.addGrant({
          roomJoin: true,
          room: roomName,
          canPublish: true,
          canSubscribe: false,
        });
        return await token.toJwt();
      }

      async function connectParticipant() {
        const roomName = roomNameInput.value.trim();
        if (!roomName) {
          alert("Please enter a room name");
          return;
        }

        participantCount++;
        const participantName = `participant-${participantCount}`;

        try {
          connectBtn.disabled = true;
          log(`Connecting ${participantName} to room: ${roomName}`);

          const token = await generateToken(roomName, participantName);

          const room = new LivekitClient.Room();
          rooms.push(room);

          // Handle transcription
          room.registerTextStreamHandler(
            "lk.transcription",
            async (reader, participantInfo) => {
              const message = await reader.readAll();
              const isFinal =
                reader.info.attributes["lk.transcription_final"] === "true";
              const trackId = reader.info.attributes["lk.transcribed_track_id"];
              if (isFinal) {
                log(
                  `New final transcription from ${participantInfo.identity} and track ${trackId}: ${message}`
                );
              } else {
                log(
                  `New interim transcription from ${participantInfo.identity} and track ${trackId}: ${message}`
                );
              }
            }
          );

          // Handle room events
          room.on(LivekitClient.RoomEvent.Connected, () => {
            log(`${participantName} connected to room`);
          });

          room.on(LivekitClient.RoomEvent.Disconnected, () => {
            log(`${participantName} disconnected from room`);
            connectBtn.disabled = false;
          });

          room.on(
            LivekitClient.RoomEvent.ParticipantConnected,
            (participant) => {
              log(`Participant joined: ${participant.identity}`);
            }
          );

          // Connect to room
          await room.connect(LIVEKIT_URL, token);

          // Publish audio track
          await room.localParticipant.setMicrophoneEnabled(true);

          log(`${participantName} published audio track`);
          connectBtn.disabled = false;
        } catch (error) {
          log(`Error: ${error.message}`);
          connectBtn.disabled = false;
        }
      }

      async function endTest() {
        log("Ending test - disconnecting all participants...");

        for (const room of rooms) {
          if (room && room.state === LivekitClient.ConnectionState.Connected) {
            await room.disconnect();
          }
        }

        rooms = [];
        participantCount = 0;
        log("All participants disconnected. Test ended.");
      }

      connectBtn.addEventListener("click", connectParticipant);
      endBtn.addEventListener("click", endTest);

      log(
        'Ready to connect. Enter a room name and click "Connect New Participant".'
      );
    </script>
  </body>
</html>
